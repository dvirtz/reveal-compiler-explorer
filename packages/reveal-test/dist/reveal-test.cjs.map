{"version":3,"file":"reveal-test.cjs","sources":["../src/reveal-test.js"],"sourcesContent":["'use strict';\n\nimport { parseCode, compile as origCompile, CompileError } from 'compiler-explorer-directives';\nimport MarkdownIt from 'markdown-it';\nimport { promises } from 'fs';\n\nconst parseMarkdownImpl = async (markdown, path, config = {}) => {\n  const md = new MarkdownIt();\n  const result = md.parse(markdown, {});\n  return []\n    .concat\n    .apply([], await Promise.all(result\n      .filter(({ type, tag }) => type === 'fence' && tag === 'code')\n      .flatMap(async ({ content, info, map }) => {\n        const [location, error] = (() => {\n          if (path) {\n            return [`${path}:${map[0] + 1}`, message => new Error(`${location}:\\n${message}`)];\n          }\n          return [undefined, message => new Error(message)];\n        })();\n        config = Object.assign(config, {\n          directives: [\n            ['fails=(.*)', (matches, info) => matches.slice(1).forEach(match => {\n              if (info.hasOwnProperty('expectedOutput')) {\n                throw error('cannot have \"fails\" and \"output\" together');\n              }\n              info.failReason = match;\n            })],\n            ['output=(.*)', (matches, info) => matches.slice(1).forEach(match => {\n              if (info.hasOwnProperty('failReason')) {\n                throw error('cannot have \"fails\" and \"output\" together');\n              }\n              info.expectedOutput = matches[1].replace(/\\\\n/g, '\\n');\n            })]\n          ]\n        });\n        const parsed = await parseCode(content.replace(/<br\\/>/g, ''), info.replace(/(\\w+).*/, '$1'), config);\n        if (!parsed) {\n          return []\n        }\n        if (parsed && location) {\n          parsed.path = location;\n        }\n        return [parsed];\n      })));\n};\n\nconst parseMarkdown = async (path, config = {}) => {\n  const markdown = await promises.readFile(path, 'utf-8');\n  return await parseMarkdownImpl(markdown, path, config);\n}\n\nconst compile = async (info, retryOptions = {}) => {\n  const error = (text) => {\n    return `${info.path}:\\n${text}`;\n  };\n  const failureMismatch = (output) => {\n    return new CompileError(-1, error(`should have failed with '${info.failReason}'${output.length > 0 ? `\\nactual output is:\\n${output}` : ''}`));\n  };\n  if (info.failReason) {\n    try {\n      const result = await origCompile(info, retryOptions);\n      throw failureMismatch(result);\n    } catch (err) {\n      if (!err.message.includes(info.failReason)) {\n        throw failureMismatch(err.message);\n      }\n      return err.message;\n    }\n  } else {\n    const result = await (async () => {\n      try {\n        return await origCompile(info, retryOptions);\n      } catch (err) {\n        const code = err.hasOwnProperty('code') ? err.code : -2;\n        throw new CompileError(err.code, error(err.message));\n      }\n    })();\n\n    if (info.hasOwnProperty('expectedOutput') && !result.includes(info.expectedOutput)) {\n      throw new CompileError(-3, error(`output mismatch:\\nactual: ${result}\\nexpected: ${info.expectedOutput}`));\n    }\n\n    return result;\n  }\n};\n\nexport { parseMarkdown, compile, CompileError };\n"],"names":["MarkdownIt","parseCode","promises","CompileError","origCompile"],"mappings":";;;;;;;;;;;;AAMA,MAAM,iBAAiB,GAAG,OAAO,QAAQ,EAAE,IAAI,EAAE,MAAM,GAAG,EAAE,KAAK;AACjE,EAAE,MAAM,EAAE,GAAG,IAAIA,8BAAU,EAAE,CAAC;AAC9B,EAAE,MAAM,MAAM,GAAG,EAAE,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;AACxC,EAAE,OAAO,EAAE;AACX,KAAK,MAAM;AACX,KAAK,KAAK,CAAC,EAAE,EAAE,MAAM,OAAO,CAAC,GAAG,CAAC,MAAM;AACvC,OAAO,MAAM,CAAC,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,KAAK,IAAI,KAAK,OAAO,IAAI,GAAG,KAAK,MAAM,CAAC;AACpE,OAAO,OAAO,CAAC,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,EAAE,KAAK;AACjD,QAAQ,MAAM,CAAC,QAAQ,EAAE,KAAK,CAAC,GAAG,CAAC,MAAM;AACzC,UAAU,IAAI,IAAI,EAAE;AACpB,YAAY,OAAO,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,OAAO,IAAI,IAAI,KAAK,CAAC,CAAC,EAAE,QAAQ,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;AAC/F,WAAW;AACX,UAAU,OAAO,CAAC,SAAS,EAAE,OAAO,IAAI,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC;AAC5D,SAAS,GAAG,CAAC;AACb,QAAQ,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE;AACvC,UAAU,UAAU,EAAE;AACtB,YAAY,CAAC,YAAY,EAAE,CAAC,OAAO,EAAE,IAAI,KAAK,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,KAAK,IAAI;AAChF,cAAc,IAAI,IAAI,CAAC,cAAc,CAAC,gBAAgB,CAAC,EAAE;AACzD,gBAAgB,MAAM,KAAK,CAAC,2CAA2C,CAAC,CAAC;AACzE,eAAe;AACf,cAAc,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;AACtC,aAAa,CAAC,CAAC;AACf,YAAY,CAAC,aAAa,EAAE,CAAC,OAAO,EAAE,IAAI,KAAK,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,KAAK,IAAI;AACjF,cAAc,IAAI,IAAI,CAAC,cAAc,CAAC,YAAY,CAAC,EAAE;AACrD,gBAAgB,MAAM,KAAK,CAAC,2CAA2C,CAAC,CAAC;AACzE,eAAe;AACf,cAAc,IAAI,CAAC,cAAc,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;AACrE,aAAa,CAAC,CAAC;AACf,WAAW;AACX,SAAS,CAAC,CAAC;AACX,QAAQ,MAAM,MAAM,GAAG,MAAMC,oCAAS,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,IAAI,CAAC,EAAE,MAAM,CAAC,CAAC;AAC9G,QAAQ,IAAI,CAAC,MAAM,EAAE;AACrB,UAAU,OAAO,EAAE;AACnB,SAAS;AACT,QAAQ,IAAI,MAAM,IAAI,QAAQ,EAAE;AAChC,UAAU,MAAM,CAAC,IAAI,GAAG,QAAQ,CAAC;AACjC,SAAS;AACT,QAAQ,OAAO,CAAC,MAAM,CAAC,CAAC;AACxB,OAAO,CAAC,CAAC,CAAC,CAAC;AACX,CAAC,CAAC;AACF;AACK,MAAC,aAAa,GAAG,OAAO,IAAI,EAAE,MAAM,GAAG,EAAE,KAAK;AACnD,EAAE,MAAM,QAAQ,GAAG,MAAMC,WAAQ,CAAC,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;AAC1D,EAAE,OAAO,MAAM,iBAAiB,CAAC,QAAQ,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;AACzD,EAAC;AACD;AACK,MAAC,OAAO,GAAG,OAAO,IAAI,EAAE,YAAY,GAAG,EAAE,KAAK;AACnD,EAAE,MAAM,KAAK,GAAG,CAAC,IAAI,KAAK;AAC1B,IAAI,OAAO,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC,CAAC;AACpC,GAAG,CAAC;AACJ,EAAE,MAAM,eAAe,GAAG,CAAC,MAAM,KAAK;AACtC,IAAI,OAAO,IAAIC,uCAAY,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,yBAAyB,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,MAAM,CAAC,MAAM,GAAG,CAAC,GAAG,CAAC,qBAAqB,EAAE,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;AACnJ,GAAG,CAAC;AACJ,EAAE,IAAI,IAAI,CAAC,UAAU,EAAE;AACvB,IAAI,IAAI;AACR,MAAM,MAAM,MAAM,GAAG,MAAMC,kCAAW,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;AAC3D,MAAM,MAAM,eAAe,CAAC,MAAM,CAAC,CAAC;AACpC,KAAK,CAAC,OAAO,GAAG,EAAE;AAClB,MAAM,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE;AAClD,QAAQ,MAAM,eAAe,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;AAC3C,OAAO;AACP,MAAM,OAAO,GAAG,CAAC,OAAO,CAAC;AACzB,KAAK;AACL,GAAG,MAAM;AACT,IAAI,MAAM,MAAM,GAAG,MAAM,CAAC,YAAY;AACtC,MAAM,IAAI;AACV,QAAQ,OAAO,MAAMA,kCAAW,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;AACrD,OAAO,CAAC,OAAO,GAAG,EAAE;AACpB,QAAQ,MAAM,IAAI,GAAG,GAAG,CAAC,cAAc,CAAC,MAAM,CAAC,GAAG,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC;AAChE,QAAQ,MAAM,IAAID,uCAAY,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC;AAC7D,OAAO;AACP,KAAK,GAAG,CAAC;AACT;AACA,IAAI,IAAI,IAAI,CAAC,cAAc,CAAC,gBAAgB,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,EAAE;AACxF,MAAM,MAAM,IAAIA,uCAAY,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,0BAA0B,EAAE,MAAM,CAAC,YAAY,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC;AACjH,KAAK;AACL;AACA,IAAI,OAAO,MAAM,CAAC;AAClB,GAAG;AACH;;;;;;;;;;;"}