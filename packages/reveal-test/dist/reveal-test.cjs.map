{"version":3,"file":"reveal-test.cjs","sources":["../src/reveal-test.js"],"sourcesContent":["'use strict';\r\n\r\nimport { parseCode, compile as origCompile, CompileError } from 'compiler-explorer-directives';\r\nimport MarkdownIt from 'markdown-it';\r\nimport { promises } from 'fs';\r\nimport cheerio from 'cheerio';\r\nimport dedent from 'dedent-js';\r\n\r\nclass ParseError extends Error {\r\n  constructor(message) {\r\n    super(message);\r\n    this.name = 'ParseError';\r\n  }\r\n}\r\n\r\nconst elementLineNumber = (container, index) => {\r\n  // https://stackoverflow.com/a/14482123/621176\r\n  const nthIndex = (str, pat, n) => {\r\n    var L = str.length, i = -1;\r\n    while (n-- && i++ < L) {\r\n      i = str.indexOf(pat, i);\r\n      if (i < 0) break;\r\n    }\r\n    return i;\r\n  };\r\n\r\n  var upToElement = container.substr(0, nthIndex(container, \"<code\", index + 1));\r\n  return (upToElement.match(/\\n\\r?/g) || []).length;\r\n}\r\n\r\nconst parseMarkdown = async (markdown, config = {}) => {\r\n  const md = new MarkdownIt({ html: true, breaks: true });\r\n  const result = md.parse(markdown, {});\r\n  const codeBlocks = result\r\n    .filter(({ type, tag }) => type === 'fence' && tag === 'code')\r\n    .map(({ content, info, map }) => { return { content: content, language: info.replace(/(\\w+).*/, '$1'), line: map[0] + 1 }; })\r\n    .concat(result\r\n      .filter(({ type }) => type === 'html_block').flatMap(({ content, info, map }) => {\r\n        const $ = cheerio.load(content);\r\n        return $('pre code').map(function (index) {\r\n          return {\r\n            content: dedent($(this).text().replace(/(\\n)/g, '$1 ')),\r\n            language: $(this).attr(\"class\"),\r\n            line: map[0] + 1 + elementLineNumber(content, index)\r\n          };\r\n        }).toArray();\r\n      }))\r\n    .sort((a, b) => a.line - b.line);\r\n  return []\r\n    .concat\r\n    .apply([], await Promise.all(codeBlocks\r\n      .flatMap(async ({ content, language, line }) => {\r\n        content.replace(/<\\/?mark>/, '');\r\n        const error = message => new ParseError(`${line}:\\n${message}`);\r\n        config = Object.assign(config, {\r\n          directives: [\r\n            ['fails=(.*)', (matches, info) => matches.slice(1).forEach(match => {\r\n              if (info.hasOwnProperty('expectedOutput')) {\r\n                throw error('cannot have \"fails\" and \"output\" together');\r\n              }\r\n              info.failReason = match;\r\n            })],\r\n            ['output=(.*)', (matches, info) => matches.slice(1).forEach(match => {\r\n              if (info.hasOwnProperty('failReason')) {\r\n                throw error('cannot have \"fails\" and \"output\" together');\r\n              }\r\n              info.expectedOutput = matches[1].replace(/\\\\n/g, '\\n');\r\n            })]\r\n          ]\r\n        });\r\n        const parsed = await parseCode(content.replace(/<br\\/>/g, ''), language, config);\r\n        if (!parsed) {\r\n          return []\r\n        }\r\n        parsed.line = line;\r\n        return [parsed];\r\n      })));\r\n};\r\n\r\nconst parseMarkdownFile = async (path, config = {}) => {\r\n  try {\r\n    const markdown = await promises.readFile(path, 'utf-8');\r\n    const parsed = await parseMarkdown(markdown, config);\r\n    return parsed.map(codeInfo => {\r\n      codeInfo.path = `${path}:${codeInfo.line}`;\r\n      delete codeInfo.line;\r\n      return codeInfo;\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof ParseError) {\r\n      throw new ParseError(`${path}:${err.message}`)\r\n    } else {\r\n      throw err;\r\n    }\r\n  }\r\n}\r\n\r\nconst compile = async (info, retryOptions = {}) => {\r\n  const error = (text) => {\r\n    return `${info.path}:\\n${text}`;\r\n  };\r\n  const failureMismatch = (output) => {\r\n    return new CompileError(-1, error(`should have failed with '${info.failReason}'${output.length > 0 ? `\\nactual output is:\\n${output}` : ''}`));\r\n  };\r\n  if (info.failReason) {\r\n    try {\r\n      const result = await origCompile(info, retryOptions);\r\n      throw failureMismatch(result);\r\n    } catch (err) {\r\n      if (!err.message.includes(info.failReason)) {\r\n        throw failureMismatch(err.message);\r\n      }\r\n      return err.message;\r\n    }\r\n  } else {\r\n    const result = await (async () => {\r\n      try {\r\n        return await origCompile(info, retryOptions);\r\n      } catch (err) {\r\n        const code = err.hasOwnProperty('code') ? err.code : -2;\r\n        throw new CompileError(err.code, error(err.message));\r\n      }\r\n    })();\r\n\r\n    if (info.hasOwnProperty('expectedOutput') && !result.includes(info.expectedOutput)) {\r\n      throw new CompileError(-3, error(`output mismatch:\\nactual: ${result}\\nexpected: ${info.expectedOutput}`));\r\n    }\r\n\r\n    return result;\r\n  }\r\n};\r\n\r\nexport { parseMarkdown, parseMarkdownFile, compile, CompileError };\r\n"],"names":["MarkdownIt","cheerio","dedent","parseCode","promises","CompileError","origCompile"],"mappings":"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"}