{"version":3,"file":"reveal-test.cjs","sources":["../src/reveal-test.js"],"sourcesContent":["'use strict';\n\nimport { parseCode, compile as origCompile, CompileError } from 'compiler-explorer-directives';\nimport MarkdownIt from 'markdown-it';\nimport { promises } from 'fs';\nimport cheerio from 'cheerio';\nimport dedent from 'dedent';\n\nclass ParseError extends Error {\n  constructor(message) {\n    super(message);\n    this.name = 'ParseError';\n  }\n}\n\nconst elementLineNumber = (container, index) => {\n  // https://stackoverflow.com/a/14482123/621176\n  const nthIndex = (str, pat, n) => {\n    var L = str.length, i = -1;\n    while (n-- && i++ < L) {\n      i = str.indexOf(pat, i);\n      if (i < 0) break;\n    }\n    return i;\n  };\n\n  var upToElement = container.substr(0, nthIndex(container, \"<code\", index + 1));\n  return (upToElement.match(/\\n\\r?/g) || []).length;\n}\n\nconst parseMarkdown = async (markdown, config = {}) => {\n  const md = new MarkdownIt({ html: true, breaks: true });\n  const result = md.parse(markdown, {});\n  const codeBlocks = result\n    .filter(({ type, tag }) => type === 'fence' && tag === 'code')\n    .map(({ content, info, map }) => { return { content: content, language: info.replace(/(\\w+).*/, '$1'), line: map[0] + 1 }; })\n    .concat(result\n      .filter(({ type }) => type === 'html_block').flatMap(({ content, info, map }) => {\n        const $ = cheerio.load(content);\n        return $('pre code').map(function (index) {\n          return {\n            content: dedent($(this).text().replace(/(\\n)/g, '$1 ')),\n            language: $(this).attr(\"class\"),\n            line: map[0] + 1 + elementLineNumber(content, index)\n          };\n        }).toArray();\n      }))\n    .sort((a, b) => a.line - b.line);\n  return []\n    .concat\n    .apply([], await Promise.all(codeBlocks\n      .flatMap(async ({ content, language, line }) => {\n        const error = message => new ParseError(`${line}:\\n${message}`);\n        config = Object.assign(config, {\n          directives: [\n            ['fails=(.*)', (matches, info) => matches.slice(1).forEach(match => {\n              if (info.hasOwnProperty('expectedOutput')) {\n                throw error('cannot have \"fails\" and \"output\" together');\n              }\n              info.failReason = match;\n            })],\n            ['output=(.*)', (matches, info) => matches.slice(1).forEach(match => {\n              if (info.hasOwnProperty('failReason')) {\n                throw error('cannot have \"fails\" and \"output\" together');\n              }\n              info.expectedOutput = matches[1].replace(/\\\\n/g, '\\n');\n            })]\n          ]\n        });\n        const parsed = await parseCode(content.replace(/<br\\/>/g, ''), language, config);\n        if (!parsed) {\n          return []\n        }\n        parsed.line = line;\n        return [parsed];\n      })));\n};\n\nconst parseMarkdownFile = async (path, config = {}) => {\n  try {\n    const markdown = await promises.readFile(path, 'utf-8');\n    const parsed = await parseMarkdown(markdown, config);\n    return parsed.map(codeInfo => {\n      codeInfo.path = `${path}:${codeInfo.line}`;\n      delete codeInfo.line;\n      return codeInfo;\n    });\n  } catch (err) {\n    if (err instanceof ParseError) {\n      throw new ParseError(`${path}:${err.message}`)\n    } else {\n      throw err;\n    }\n  }\n}\n\nconst compile = async (info, retryOptions = {}) => {\n  const error = (text) => {\n    return `${info.path}:\\n${text}`;\n  };\n  const failureMismatch = (output) => {\n    return new CompileError(-1, error(`should have failed with '${info.failReason}'${output.length > 0 ? `\\nactual output is:\\n${output}` : ''}`));\n  };\n  if (info.failReason) {\n    try {\n      const result = await origCompile(info, retryOptions);\n      throw failureMismatch(result);\n    } catch (err) {\n      if (!err.message.includes(info.failReason)) {\n        throw failureMismatch(err.message);\n      }\n      return err.message;\n    }\n  } else {\n    const result = await (async () => {\n      try {\n        return await origCompile(info, retryOptions);\n      } catch (err) {\n        const code = err.hasOwnProperty('code') ? err.code : -2;\n        throw new CompileError(err.code, error(err.message));\n      }\n    })();\n\n    if (info.hasOwnProperty('expectedOutput') && !result.includes(info.expectedOutput)) {\n      throw new CompileError(-3, error(`output mismatch:\\nactual: ${result}\\nexpected: ${info.expectedOutput}`));\n    }\n\n    return result;\n  }\n};\n\nexport { parseMarkdown, parseMarkdownFile, compile, CompileError };\n"],"names":["MarkdownIt","cheerio","dedent","parseCode","promises","CompileError","origCompile"],"mappings":"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"}